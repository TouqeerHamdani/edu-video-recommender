<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Watch Video - EduTV</title>
  <link rel="stylesheet" href="/static/project.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .video-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .video-container iframe {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 8px;
    }

    .video-meta {
      margin-top: 16px;
    }

    .video-meta h2 {
      color: #222;
      margin-bottom: 6px;
    }

    .video-meta p {
      color: #888;
      font-size: 1rem;
    }

    .video-actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
    }

    .video-actions button {
      padding: 8px 20px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
    }

    .video-actions button:hover {
      background: #e0e0e0;
    }

    .video-actions button.liked {
      background: #ff6b6b;
      color: #fff;
      border-color: #ff6b6b;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <a href="/" class="logo" style="text-decoration:none; color:white;">EduTV</a>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search for topics...">
      <button id="searchBtn"><i class="fas fa-search"></i></button>
    </div>
    <span id="authNav" style="margin-left:auto; font-size:0.9rem;">
      <a href="/auth" id="loginBtn" style="color:#007bff; text-decoration:none;">Login</a>
      <span id="userInfo" style="display:none; color:#ccc;">
        <span id="userEmail"></span>
        &nbsp;|&nbsp;
        <a href="#" id="logoutBtn" style="color:#ff6b6b; text-decoration:none;">Logout</a>
      </span>
    </span>
  </div>

  <div class="video-container">
    <div id="video-player"></div>
    <div class="video-meta">
      <h2 id="video-title"></h2>
      <p id="video-channel"></p>
    </div>
    <div class="video-actions">
      <button id="likeBtn"><i class="fas fa-heart"></i> Like</button>
    </div>
  </div>

  <footer>
    <p><a href="/">Back to Home</a></p>
  </footer>

  <script src="/static/project.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const videoId = params.get("videoId");
    const title = params.get("title");
    const channel = params.get("channel");

    if (videoId && /^[\w-]+$/.test(videoId)) {
      document.getElementById("video-player").innerHTML = `
        <iframe src="https://www.youtube.com/embed/${videoId}"
          frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen></iframe>
      `;
    }

    if (title) document.getElementById("video-title").textContent = decodeURIComponent(title);
    if (channel) document.getElementById("video-channel").textContent = decodeURIComponent(channel);

    // --- Like button ---
    const likeBtn = document.getElementById("likeBtn");
    likeBtn.addEventListener("click", async () => {
      if (likeBtn.classList.contains('liked')) return;
      if (!videoId) {
        alert('Cannot like: video ID is missing.');
        return;
      }

      try {
        const res = await fetch('/api/interactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            video_id: videoId,
            interaction_type: 'like'
          })
        });

        if (res.ok) {
          likeBtn.classList.add('liked');
          likeBtn.innerHTML = '<i class="fas fa-heart"></i> Liked';
        } else if (res.status === 401) {
          alert('Please log in to like videos.');
          window.location.href = '/auth';
        } else {
          const errData = await res.json().catch(() => ({}));
          alert(`Could not like video: ${errData.error || errData.detail || res.statusText}`);
        }
      } catch (err) {
        console.error("Like error:", err);
      }
    });
  </script>
</body>

</html>